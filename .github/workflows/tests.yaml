name: Run Tests

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:latest
        ports:
          - 27017:27017
      redis:
        image: redis:latest
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run Tests
        run: bun test
        env:
          # Match the service ports mapped above
          MONGODB_URI: mongodb://localhost:27017/project-camp-test
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          # Dummy secrets for testing (must match what tests expect if not hardcoded)
          ACCESS_TOKEN_SECRET: test_access_secret
          REFRESH_TOKEN_SECRET: test_refresh_secret
          ACCESS_TOKEN_EXPIRY: 1h
          REFRESH_TOKEN_EXPIRY: 7d
          CORS_ORIGIN: http://localhost:5173
          PORT: 8000